<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Time Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles if needed */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4 text-center text-gray-800">Calendar Time Analyzer</h1>

        <div class="mb-6 p-4 bg-blue-50 rounded-md border border-blue-200">
            <h2 class="text-lg font-semibold mb-3 text-blue-800">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="startHour" class="block text-sm font-medium text-gray-700 mb-1">Work Start Hour (0-23):</label>
                    <input type="number" id="startHour" value="9" min="0" max="23" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="endHour" class="block text-sm font-medium text-gray-700 mb-1">Work End Hour (0-23):</label>
                    <input type="number" id="endHour" value="17" min="0" max="23" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="daysToQuery" class="block text-sm font-medium text-gray-700 mb-1">Number of Past Days:</label>
                    <input type="number" id="daysToQuery" value="7" min="1" max="90" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
             <p class="text-xs text-gray-500 mt-2">Note: Analysis uses your browser's local time zone and excludes weekends.</p>
        </div>

        <div class="flex justify-center space-x-4 mb-6">
            <button id="authorize_button" onclick="handleAuthClick()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                Sign In & Authorize
            </button>
            <button id="signout_button" onclick="handleSignoutClick()" style="display: none;" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">
                Sign Out
            </button>
             <button id="fetch_button" onclick="fetchCalendarData()" style="display: none;" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50">
                Fetch & Analyze Data <span id="loadingSpinner" class="loader" style="display: none;"></span>
            </button>
        </div>

        <div id="results" class="mt-6 p-4 bg-gray-50 rounded-md border border-gray-200" style="display: none;">
             <h2 class="text-lg font-semibold mb-4 text-center text-gray-800">Analysis Results</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                 <div class="relative h-64 w-64 mx-auto md:h-72 md:w-72">
                      <canvas id="utilizationChart"></canvas>
                      <p id="chart-message" class="absolute inset-0 flex items-center justify-center text-center text-gray-500 text-sm p-4" style="display: none;"></p>
                 </div>
                 <div id="numerical-results" class="text-sm text-gray-700 space-y-2">
                      {-- Numerical data will be populated here by JS --}
                 </div>
             </div>
             <div id="error-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md" style="display: none;"></div>
        </div>

         <div id="message-box" class="fixed top-5 right-5 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md shadow-lg" role="alert" style="display: none; z-index: 1000;">
            <strong class="font-bold">Notice:</strong>
            <span class="block sm:inline" id="message-text"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="closeMessageBox()">
                <svg class="fill-current h-6 w-6 text-yellow-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

    </div>

    <script>
        // --- Configuration ---
        const CLIENT_ID = '132109609630-rtd6vrmntsjm8iljhk8f0cfe1rqr6l3b.apps.googleusercontent.com'; // IMPORTANT: Replace with your actual Google Client ID
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

        // --- Global Variables ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let utilizationChartInstance = null; // To hold the chart instance

        // --- DOM Elements ---
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const fetchButton = document.getElementById('fetch_button');
        const resultsDiv = document.getElementById('results');
        const contentElement = document.getElementById('content'); // Keep for potential fallback/debug
        const numericalResultsDiv = document.getElementById('numerical-results'); // New div for text results
        const chartCanvas = document.getElementById('utilizationChart'); // Chart canvas
        const chartMessageElement = document.getElementById('chart-message'); // Message overlay for chart area
        const errorMessageElement = document.getElementById('error-message');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // --- Initialization (Functions remain the same) ---
        function gapiLoadedCallback() {
            console.log("GAPI script loaded via callback.");
            gapi.load('client', initializeGapiClient);
        }
        async function initializeGapiClient() {
            console.log("Attempting to initialize GAPI client...");
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                });
                gapiInited = true;
                console.log("GAPI client initialized successfully.");
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GAPI client:', error);
                displayError('Failed to initialize Google API Client. Check console for details.');
                gapiInited = false;
                maybeEnableButtons();
            }
        }
        function initializeGisClient() {
             console.log("Attempting to initialize GIS token client...");
             if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                 console.error("GIS library (google.accounts.oauth2) not loaded yet.");
                 displayError('Failed to initialize Google Sign-In library. Please refresh the page.');
                 gisInited = false;
                 maybeEnableButtons();
                 return;
             }
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: tokenResponseCallback,
                    error_callback: handleGisError,
                });
                gisInited = true;
                console.log("GIS token client initialized successfully.");
            } catch (error) {
                console.error('Error initializing GIS client:', error);
                displayError('Failed to initialize Google Sign-In. Is the Client ID correct? Check console.');
                gisInited = false;
            }
            maybeEnableButtons();
        }

        // --- Authentication (Functions remain the same) ---
        function handleAuthClick() {
            console.log("handleAuthClick called");
             if (!gisInited || !tokenClient) {
                console.error("Token client not initialized yet.");
                displayMessage("Initialization incomplete. Please wait a moment and try again.");
                return;
            }
            if (gapi.client.getToken() === null) {
                 console.log("Requesting access token with consent prompt.");
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                console.log("Requesting access token without prompt (existing session).");
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        function tokenResponseCallback(resp) {
            if (resp.error) {
                 console.error('GIS Token Error:', resp.error, resp);
                 let message = `Error getting access token: ${resp.error}`;
                 // ... (error handling messages remain the same)
                  if (resp.error === 'popup_closed_by_user') {
                    message = 'Sign-in popup closed before completion.';
                 } else if (resp.error === 'access_denied') {
                     message = 'Access denied. Please grant permission to access your calendar.';
                 } else if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                    message = 'Error: Please replace "YOUR_GOOGLE_CLIENT_ID" in the code with your actual Google Client ID.';
                 } else if (resp.error === 'invalid_request' || resp.error === 'unauthorized_client' || resp.error === 'invalid_grant' || resp.error === 'invalid_scope') {
                     message = `Authorization error (${resp.error}). Check Client ID, Authorized Origins, and Scopes in Google Cloud Console.`;
                 }
                 displayMessage(message);
                 updateSigninStatus(false);
                 return;
            }
            console.log("Access token received successfully.");
            gapi.client.setToken(resp);
            updateSigninStatus(true);
            displayMessage('Authorization successful! You can now fetch data.');
        }
        function handleGisError(error) {
            console.error('GIS Error during token request:', error);
            let message = `Google Sign-In Error: ${error.type || 'Unknown error'}.`;
             // ... (error handling messages remain the same)
             if (error.type === 'popup_closed') {
                message = 'Sign-in popup was closed before completion.';
             } else if (error.type === 'session_not_created' && error.message?.includes('invalid client id')) {
                 message = 'Sign-in Error: Invalid Client ID. Please ensure it is configured correctly in the Google Cloud Console and in the script.';
             } else if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                 message = 'Error: Please replace "YOUR_GOOGLE_CLIENT_ID" in the code with your actual Google Client ID.';
             } else if (error.message) {
                 message += ` Details: ${error.message}`;
             }
            displayMessage(message);
            updateSigninStatus(false);
        }
        function handleSignoutClick() {
            console.log("handleSignoutClick called");
            // Destroy chart if it exists
            if (utilizationChartInstance) {
                utilizationChartInstance.destroy();
                utilizationChartInstance = null;
                console.log("Chart destroyed on sign out.");
            }
            const token = gapi.client.getToken();
            if (token !== null) {
                 console.log("Revoking token...");
                 if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && google.accounts.oauth2.revoke) {
                    google.accounts.oauth2.revoke(token.access_token, (done) => {
                        console.log("Token revoked callback:", done);
                        gapi.client.setToken('');
                        updateSigninStatus(false);
                        resultsDiv.style.display = 'none';
                        numericalResultsDiv.innerHTML = ''; // Clear numerical results
                        errorMessageElement.style.display = 'none';
                        displayMessage('You have been signed out.');
                    });
                 } else {
                     console.error("google.accounts.oauth2.revoke function not found. Cannot revoke token.");
                     gapi.client.setToken('');
                     updateSigninStatus(false);
                     displayMessage('Signed out locally (could not contact Google to revoke).');
                 }
            } else {
                 console.log("No token found to revoke, updating UI.");
                 updateSigninStatus(false);
                 resultsDiv.style.display = 'none'; // Hide results even if no token
                 numericalResultsDiv.innerHTML = ''; // Clear numerical results
            }
        }
        function updateSigninStatus(isSignedIn) {
             console.log("Updating sign-in status:", isSignedIn);
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'inline-block';
                fetchButton.style.display = 'inline-block';
                fetchButton.disabled = false;
            } else {
                authorizeButton.style.display = 'inline-block';
                signoutButton.style.display = 'none';
                fetchButton.style.display = 'none';
                fetchButton.disabled = true;
                maybeEnableButtons();
            }
        }
        function maybeEnableButtons() {
            console.log(`Checking button status: GAPI=${gapiInited}, GIS=${gisInited}`);
            if (gapiInited && gisInited) {
                 console.log("Both GAPI and GIS initialized.");
                 if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                    authorizeButton.disabled = true;
                    console.log("Authorize button kept disabled: Client ID placeholder found.");
                } else {
                    const isSignedIn = gapi.client.getToken() !== null;
                     authorizeButton.disabled = isSignedIn;
                     console.log(`Authorize button enabled state set to: ${!isSignedIn}`);
                     if(isSignedIn) {
                        authorizeButton.style.display = 'none';
                     } else {
                        authorizeButton.style.display = 'inline-block';
                     }
                }
            } else {
                console.log("Initialization incomplete. Keeping authorize button disabled.");
                 authorizeButton.disabled = true;
            }
        }

        // --- Calendar Data Fetching and Analysis (Functions remain the same) ---
        async function fetchCalendarData() {
             console.log("fetchCalendarData called");
            const startHourInput = parseInt(document.getElementById('startHour').value, 10);
            const endHourInput = parseInt(document.getElementById('endHour').value, 10);
            const daysToQueryInput = parseInt(document.getElementById('daysToQuery').value, 10);

            if (isNaN(startHourInput) || isNaN(endHourInput) || isNaN(daysToQueryInput) ||
                startHourInput < 0 || startHourInput > 23 || endHourInput <= startHourInput || endHourInput > 23 ||
                daysToQueryInput < 1 || daysToQueryInput > 90) {
                displayError("Invalid input. Check start/end hours (0-23, end > start) and days (1-90).");
                return;
            }

            fetchButton.disabled = true;
            loadingSpinner.style.display = 'inline-block';
            resultsDiv.style.display = 'none'; // Hide results initially
            numericalResultsDiv.innerHTML = ''; // Clear previous numerical results
            errorMessageElement.style.display = 'none';
            chartCanvas.style.display = 'none'; // Hide canvas initially
            chartMessageElement.style.display = 'none'; // Hide chart message

            // Destroy previous chart instance if it exists
            if (utilizationChartInstance) {
                utilizationChartInstance.destroy();
                utilizationChartInstance = null;
                console.log("Previous chart destroyed.");
            }

            try {
                const now = new Date();
                const timeMax = new Date(now);
                timeMax.setHours(23, 59, 59, 999);
                const timeMin = new Date(now);
                timeMin.setDate(now.getDate() - daysToQueryInput);
                timeMin.setHours(0, 0, 0, 0);
                 console.log(`Fetching events from ${timeMin.toISOString()} to ${timeMax.toISOString()}`);
                const events = await listUpcomingEvents(timeMin.toISOString(), timeMax.toISOString());
                if (events === null) {
                     console.log("Event fetching failed or returned null.");
                    return; // Error already displayed
                }
                 console.log(`Fetched ${events.length} events.`);
                const analysis = analyzeEvents(events, timeMin, daysToQueryInput, startHourInput, endHourInput);
                 console.log("Analysis complete:", analysis);
                displayResults(analysis, startHourInput, endHourInput, daysToQueryInput); // Call updated display function
            } catch (err) {
                console.error('Error fetching or analyzing calendar data:', err);
                displayError(`Error: ${err.message || 'Could not fetch or analyze data.'}`);
            } finally {
                 fetchButton.disabled = false;
                 loadingSpinner.style.display = 'none';
                 console.log("Fetch/Analyze process finished.");
            }
        }
        async function listUpcomingEvents(timeMinISO, timeMaxISO) {
            // ... (function remains the same)
             console.log("Calling Google Calendar API events.list");
             if (!gapiInited || !gapi.client || !gapi.client.calendar) {
                 console.error("GAPI client or Calendar API not initialized.");
                 displayError("GAPI client or Calendar API not ready. Please wait or refresh.");
                 return null;
             }
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': timeMinISO,
                    'timeMax': timeMaxISO,
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 2500,
                    'orderBy': 'startTime'
                });
                 console.log("Calendar API response received:", response);
                return response.result.items || [];
            } catch (err) {
                console.error('Google Calendar API Error:', err);
                let errorMsg = `Failed to fetch calendar events: ${err.result?.error?.message || err.message || 'Unknown API error.'}`;
                 if (err.result?.error?.status === 'PERMISSION_DENIED') {
                     errorMsg += ' Ensure you granted calendar access permission during sign-in.';
                 } else if (err.result?.error?.status === 'NOT_FOUND') {
                     errorMsg = 'Primary calendar not found for this account.';
                 } else if (err.status === 401 || err.result?.error?.code === 401) {
                     errorMsg = 'Authorization expired or invalid. Please Sign Out and Sign In again.';
                     handleSignoutClick();
                 } else if (err.status === 403 || err.result?.error?.code === 403) {
                     errorMsg = `Permission denied (${err.result?.error?.message || 'Forbidden'}). Check API permissions in Google Cloud Console.`;
                 }
                displayError(errorMsg);
                return null;
            }
        }
        function analyzeEvents(events, startDate, numDays, workStartHour, workEndHour) {
             // ... (function remains the same)
            console.log(`Analyzing ${events.length} events over ${numDays} days (starting from ${startDate.toDateString()}) between ${workStartHour}:00 and ${workEndHour}:00.`);
            let totalMeetingMinutes = 0;
            let totalWorkMinutes = 0;
            let processedWeekdays = 0;
            const oneDayMillis = 24 * 60 * 60 * 1000;

            for (let i = 0; i < numDays; i++) {
                const currentDay = new Date(startDate.getTime() + i * oneDayMillis);
                const dayOfWeek = currentDay.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { continue; }
                processedWeekdays++;
                const workStartTime = new Date(currentDay);
                workStartTime.setHours(workStartHour, 0, 0, 0);
                const workEndTime = new Date(currentDay);
                workEndTime.setHours(workEndHour, 0, 0, 0);
                const workStartTimeMillis = workStartTime.getTime();
                const workEndTimeMillis = workEndTime.getTime();
                const dailyWorkMinutes = (workEndTimeMillis - workStartTimeMillis) / (1000 * 60);
                 // Ensure dailyWorkMinutes is not negative if endHour < startHour accidentally
                 if (dailyWorkMinutes > 0) {
                    totalWorkMinutes += dailyWorkMinutes;
                 }

                events.forEach(event => {
                    if (!event.start?.dateTime || !event.end?.dateTime) { return; }
                    const eventStartMillis = new Date(event.start.dateTime).getTime();
                    const eventEndMillis = new Date(event.end.dateTime).getTime();
                    const overlapStart = Math.max(eventStartMillis, workStartTimeMillis);
                    const overlapEnd = Math.min(eventEndMillis, workEndTimeMillis);
                    if (overlapEnd > overlapStart) {
                        totalMeetingMinutes += (overlapEnd - overlapStart) / (1000 * 60);
                    }
                });
            }
             console.log(`Finished analysis: ${processedWeekdays} weekdays processed. Total work minutes: ${totalWorkMinutes}, Total meeting minutes: ${Math.round(totalMeetingMinutes)}`);
            return {
                totalMeetingMinutes: Math.round(totalMeetingMinutes),
                totalWorkMinutes: Math.round(totalWorkMinutes), // Round total work minutes as well
                processedWeekdays: processedWeekdays
            };
        }

        // --- UI Display Functions ---

        // Displays the analysis results (Updated)
        function displayResults(analysis, startHour, endHour, totalDaysQueried) {
            resultsDiv.style.display = 'block'; // Show the main results container
            errorMessageElement.style.display = 'none'; // Hide any previous errors
            numericalResultsDiv.innerHTML = ''; // Clear previous numerical results
            chartCanvas.style.display = 'none'; // Hide chart initially
            chartMessageElement.style.display = 'none'; // Hide chart message

            const { totalMeetingMinutes, totalWorkMinutes, processedWeekdays } = analysis;

            // --- Populate Numerical Results ---
            let numericalOutput = `<p class="font-semibold text-gray-800">Period Analyzed:</p>`;
            numericalOutput += `<p>Past ${totalDaysQueried} day(s) (${processedWeekdays} weekdays)</p>`;
            numericalOutput += `<p class="mt-2 font-semibold text-gray-800">Work Hours Configured:</p>`;
            numericalOutput += `<p>${startHour}:00 - ${endHour}:00 (Local Time)</p>`;

            if (processedWeekdays === 0) {
                 numericalOutput += `<p class="mt-4 text-red-600">No weekdays found in the selected period to analyze.</p>`;
                 numericalResultsDiv.innerHTML = numericalOutput;
                 console.log("Results displayed: No weekdays.");
                 return; // Stop here if no weekdays
            }

             // Calculate derived values
            const meetingHours = (totalMeetingMinutes / 60).toFixed(1);
            const totalWorkHours = totalWorkMinutes > 0 ? (totalWorkMinutes / 60).toFixed(1) : '0.0';
            // Ensure workingMinutes is not negative
            const workingMinutes = Math.max(0, totalWorkMinutes - totalMeetingMinutes);
            const workingHours = (workingMinutes / 60).toFixed(1);
            const meetingPercentage = totalWorkMinutes > 0 ? ((totalMeetingMinutes / totalWorkMinutes) * 100).toFixed(1) : '0.0';
            const workingPercentage = totalWorkMinutes > 0 ? ((workingMinutes / totalWorkMinutes) * 100).toFixed(1) : '0.0';


            numericalOutput += `<p class="mt-2 font-semibold text-gray-800">Time Allocation:</p>`;
            numericalOutput += `<ul class="list-disc list-inside space-y-1">`;
            numericalOutput += `<li>Total Available Work Time: <span class="font-medium">${totalWorkHours} hrs</span> (${totalWorkMinutes} min)</li>`;
            numericalOutput += `<li>Time in Meetings: <span class="font-medium">${meetingHours} hrs</span> (${totalMeetingMinutes} min)</li>`;
            numericalOutput += `<li>Est. Work Time (Non-Meeting): <span class="font-medium">${workingHours} hrs</span> (${workingMinutes} min)</li>`;
            numericalOutput += `</ul>`;
            numericalOutput += `<p class="mt-2 font-semibold text-gray-800">Utilization:</p>`;
             numericalOutput += `<ul class="list-disc list-inside space-y-1">`;
            numericalOutput += `<li>Meeting Percentage: <span class="font-medium text-red-600">${meetingPercentage}%</span></li>`;
            numericalOutput += `<li>Est. Work Percentage: <span class="font-medium text-blue-600">${workingPercentage}%</span></li>`;
             numericalOutput += `</ul>`;

            numericalResultsDiv.innerHTML = numericalOutput; // Add text results to the DOM

            // --- Create Chart ---
            if (totalWorkMinutes > 0) {
                chartCanvas.style.display = 'block'; // Show the canvas
                const ctx = chartCanvas.getContext('2d');

                 // Destroy previous chart instance (redundant check, but safe)
                if (utilizationChartInstance) {
                    utilizationChartInstance.destroy();
                }

                utilizationChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Meetings', 'Work Time (Est.)'],
                        datasets: [{
                            label: 'Time Allocation (minutes)',
                            data: [totalMeetingMinutes, workingMinutes], // Use calculated workingMinutes
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.7)',  // Red-500 with opacity
                                'rgba(59, 130, 246, 0.7)' // Blue-500 with opacity
                            ],
                             borderColor: [
                                'rgba(239, 68, 68, 1)',  // Red-500 solid
                                'rgba(59, 130, 246, 1)' // Blue-500 solid
                            ],
                            borderWidth: 1,
                            hoverOffset: 8,
                             hoverBackgroundColor: [ // Slightly darker on hover
                                'rgba(220, 38, 38, 0.8)', // Red-600
                                'rgba(37, 99, 235, 0.8)'  // Blue-600
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%', // Makes it a doughnut chart
                        plugins: {
                            legend: {
                                position: 'bottom', // Move legend below chart
                                labels: {
                                    padding: 15 // Add padding to legend items
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            const valueMinutes = context.parsed;
                                            const valueHours = (valueMinutes / 60).toFixed(1);
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((valueMinutes / total) * 100).toFixed(1) : 0;
                                            label += `${valueHours} hrs (${valueMinutes} min) - ${percentage}%`;
                                        }
                                        return label;
                                    }
                                }
                            },
                             title: { // Add a title to the chart
                                display: true,
                                text: 'Work Hours Allocation',
                                padding: {
                                    top: 10,
                                    bottom: 10
                                },
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                });
                console.log("Chart created and displayed.");
            } else {
                 // If totalWorkMinutes is 0, display a message in the chart area
                 chartMessageElement.innerText = "No work time calculated for this period, cannot display chart.";
                 chartMessageElement.style.display = 'flex'; // Use flex to center text
                 chartCanvas.style.display = 'none'; // Ensure canvas is hidden
                 console.log("Chart not displayed: Zero total work minutes.");
            }
        }

        function displayError(message) {
            console.log("Displaying error:", message);
            resultsDiv.style.display = 'block'; // Show results container to display the error
            errorMessageElement.innerText = message;
            errorMessageElement.style.display = 'block';
            numericalResultsDiv.innerHTML = ''; // Clear numerical results on error
            chartCanvas.style.display = 'none'; // Hide chart on error
            chartMessageElement.style.display = 'none'; // Hide chart message

            // Destroy chart if it exists when an error occurs
            if (utilizationChartInstance) {
                utilizationChartInstance.destroy();
                utilizationChartInstance = null;
                console.log("Chart destroyed due to error.");
            }
        }

        function displayMessage(text) {
             console.log("Displaying message:", text);
            messageText.innerText = text;
            messageBox.style.display = 'block';
            setTimeout(closeMessageBox, 5000);
        }

        function closeMessageBox() {
            messageBox.style.display = 'none';
        }


        // --- Load Libraries and Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            authorizeButton.disabled = true;
            fetchButton.disabled = true;
            console.log("Initial button states set (disabled).");
             if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                 displayMessage('Setup Required: Please replace "YOUR_GOOGLE_CLIENT_ID" in the HTML\'s JavaScript section with your actual Google Client ID.');
                 console.warn("Client ID placeholder detected. Authorization will remain disabled.");
             }
            initializeGisClient();
            window.gapiLoaded = gapiLoadedCallback;
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js?onload=gapiLoaded';
            gapiScript.async = true;
            gapiScript.defer = true;
            document.body.appendChild(gapiScript);
            console.log("GAPI script added to body with onload callback.");
        });

    </script>
</body>
</html>
