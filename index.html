<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Time Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite; display: inline-block;
            margin-left: 10px; vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .weekday-label { display: inline-flex; align-items: center; margin-right: 1rem; cursor: pointer; }
        .weekday-checkbox { margin-right: 0.3rem; }
    </style>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/workUtilization/site.webmanifest">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Calendar Time Analyzer</h1>

        <div class="mb-6 p-4 bg-blue-50 rounded-md border border-blue-200 space-y-4">
             <h2 class="text-lg font-semibold mb-3 text-blue-800">Configuration</h2>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div> <label for="startHour" class="block text-sm font-medium text-gray-700 mb-1">Work Start Hour (0-23):</label> <input type="number" id="startHour" value="9" min="0" max="23" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"> </div>
                 <div> <label for="endHour" class="block text-sm font-medium text-gray-700 mb-1">Work End Hour (0-23):</label> <input type="number" id="endHour" value="17" min="0" max="23" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"> </div>
                 <div> <label for="daysToQuery" class="block text-sm font-medium text-gray-700 mb-1">Number of Past Days:</label> <input type="number" id="daysToQuery" value="7" min="1" max="90" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"> </div>
             </div>
             <div> <label class="block text-sm font-medium text-gray-700 mb-1">Work Weekdays:</label> <div id="weekdays-container" class="flex flex-wrap gap-y-1"> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="0"> Sun</label> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="1" checked> Mon</label> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="2" checked> Tue</label> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="3" checked> Wed</label> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="4" checked> Thu</label> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="5" checked> Fri</label> <label class="weekday-label"><input type="checkbox" class="weekday-checkbox" value="6"> Sat</label> </div> </div>
             <div> <label for="timeZone" class="block text-sm font-medium text-gray-700 mb-1">Analysis Timezone:</label> <select id="timeZone" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"> <option value="local">Local Browser Time</option> <option value="UTC">UTC</option> <option value="America/New_York">America/New_York (ET)</option> <option value="America/Chicago">America/Chicago (CT)</option> <option value="America/Denver">America/Denver (MT)</option> <option value="America/Los_Angeles">America/Los_Angeles (PT)</option> <option value="Europe/London">Europe/London (GMT/BST)</option> <option value="Europe/Paris">Europe/Paris (CET/CEST)</option> <option value="Asia/Tokyo">Asia/Tokyo (JST)</option> <option value="Australia/Sydney">Australia/Sydney (AET/AEDT)</option> </select> <p class="text-xs text-gray-500 mt-1">Determines the time range (e.g., 9-5) for analysis.</p> </div>
        </div>

        <div class="flex justify-center space-x-4 mb-6">
             <button id="authorize_button" onclick="handleAuthClick()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50" disabled> Sign In & Authorize </button> <button id="signout_button" onclick="handleSignoutClick()" style="display: none;" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out"> Sign Out </button> <button id="fetch_button" onclick="fetchCalendarData()" style="display: none;" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50"> Fetch & Analyze Data <span id="loadingSpinner" class="loader" style="display: none;"></span> </button>
        </div>

        <div id="results" class="mt-6 p-4 bg-gray-50 rounded-md border border-gray-200 space-y-6" style="display: none;">
             <h2 class="text-lg font-semibold text-center text-gray-800">Analysis Results</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                 <div class="relative w-full max-w-xs mx-auto h-64 md:max-w-sm md:h-72">
                      <canvas id="utilizationChart"></canvas>
                      <p id="chart-message" class="absolute inset-0 flex items-center justify-center text-center text-gray-500 text-sm p-4" style="display: none;"></p>
                 </div>
                 <div id="numerical-results" class="text-sm text-gray-700 space-y-2"></div>
             </div>
             <div id="error-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md" style="display: none;"></div>
             <div id="daily-breakdown" class="pt-4 border-t border-gray-300"></div>
        </div>

        <div id="message-box" class="fixed top-5 right-5 bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-md shadow-lg" role="alert" style="display: none; z-index: 1000;">
             <strong class="font-bold">Notice:</strong> <span class="block sm:inline" id="message-text"></span> <span class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="closeMessageBox()"> <svg class="fill-current h-6 w-6 text-yellow-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg> </span>
        </div>
    </div>

    <script>
        // --- Configuration, Globals, DOM Elements --- (No changes)
        const CLIENT_ID = '132109609630-rtd6vrmntsjm8iljhk8f0cfe1rqr6l3b.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let utilizationChartInstance = null;
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const fetchButton = document.getElementById('fetch_button');
        const resultsDiv = document.getElementById('results');
        const numericalResultsDiv = document.getElementById('numerical-results');
        const chartCanvas = document.getElementById('utilizationChart');
        const chartMessageElement = document.getElementById('chart-message');
        const errorMessageElement = document.getElementById('error-message');
        const dailyBreakdownDiv = document.getElementById('daily-breakdown');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const weekdaysContainer = document.getElementById('weekdays-container');
        const timeZoneSelect = document.getElementById('timeZone');

        // --- Initialization Functions --- (No changes)
        function gapiLoadedCallback() { console.log("GAPI script loaded via callback."); gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { console.log("Attempting to initialize GAPI client..."); try { await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'], }); gapiInited = true; console.log("GAPI client initialized successfully."); maybeEnableButtons(); } catch (error) { console.error('Error initializing GAPI client:', error); displayError('Failed to initialize Google API Client. Check console for details.'); gapiInited = false; maybeEnableButtons(); } }
        function initializeGisClient() { console.log("Attempting to initialize GIS token client..."); if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) { console.error("GIS library (google.accounts.oauth2) not available when expected."); displayError('Failed to initialize Google Sign-In library components. Please refresh.'); gisInited = false; maybeEnableButtons(); return; } try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: tokenResponseCallback, error_callback: handleGisError, }); gisInited = true; console.log("GIS token client initialized successfully."); } catch (error) { console.error('Error initializing GIS token client:', error); displayError('Failed to initialize Google Sign-In token client. Is the Client ID correct? Check console.'); gisInited = false; } maybeEnableButtons(); }

        // --- Authentication Functions --- (No changes)
        function handleAuthClick() { console.log("handleAuthClick called"); if (!gisInited || !tokenClient) { console.error("Token client not initialized yet."); displayMessage("Initialization incomplete. Please wait a moment and try again."); return; } if (gapi.client.getToken() === null) { console.log("Requesting access token with consent prompt."); tokenClient.requestAccessToken({prompt: 'consent'}); } else { console.log("Requesting access token without prompt (existing session)."); tokenClient.requestAccessToken({prompt: ''}); } }
        function tokenResponseCallback(resp) { if (resp.error) { console.error('GIS Token Error:', resp.error, resp); let message = `Error getting access token: ${resp.error}`; if (resp.error === 'popup_closed_by_user') { message = 'Sign-in popup closed before completion.'; } else if (resp.error === 'access_denied') { message = 'Access denied. Please grant permission to access your calendar.'; } else if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') { message = 'Error: Please replace "YOUR_GOOGLE_CLIENT_ID" in the code with your actual Google Client ID.'; } else if (resp.error === 'invalid_request' || resp.error === 'unauthorized_client' || resp.error === 'invalid_grant' || resp.error === 'invalid_scope') { message = `Authorization error (${resp.error}). Check Client ID, Authorized Origins, and Scopes in Google Cloud Console.`; } displayMessage(message); updateSigninStatus(false); return; } console.log("Access token received successfully."); gapi.client.setToken(resp); updateSigninStatus(true); displayMessage('Authorization successful! You can now fetch data.'); }
        function handleGisError(error) { console.error('GIS Error during token request:', error); let message = `Google Sign-In Error: ${error.type || 'Unknown error'}.`; if (error.type === 'popup_closed') { message = 'Sign-in popup was closed before completion.'; } else if (error.type === 'session_not_created' && error.message?.includes('invalid client id')) { message = 'Sign-in Error: Invalid Client ID. Please ensure it is configured correctly in the Google Cloud Console and in the script.'; } else if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') { message = 'Error: Please replace "YOUR_GOOGLE_CLIENT_ID" in the code with your actual Google Client ID.'; } else if (error.message) { message += ` Details: ${error.message}`; } displayMessage(message); updateSigninStatus(false); }
        function handleSignoutClick() { console.log("handleSignoutClick called"); if (utilizationChartInstance) { utilizationChartInstance.destroy(); utilizationChartInstance = null; console.log("Chart destroyed on sign out."); } const token = gapi.client.getToken(); if (token !== null) { console.log("Revoking token..."); if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && google.accounts.oauth2.revoke) { google.accounts.oauth2.revoke(token.access_token, (done) => { console.log("Token revoked callback:", done); gapi.client.setToken(''); updateSigninStatus(false); resultsDiv.style.display = 'none'; numericalResultsDiv.innerHTML = ''; dailyBreakdownDiv.innerHTML = ''; errorMessageElement.style.display = 'none'; displayMessage('You have been signed out.'); }); } else { console.error("google.accounts.oauth2.revoke function not found. Cannot revoke token."); gapi.client.setToken(''); updateSigninStatus(false); displayMessage('Signed out locally (could not contact Google to revoke).'); } } else { console.log("No token found to revoke, updating UI."); updateSigninStatus(false); resultsDiv.style.display = 'none'; numericalResultsDiv.innerHTML = ''; dailyBreakdownDiv.innerHTML = ''; } }
        function updateSigninStatus(isSignedIn) { console.log("Updating sign-in status:", isSignedIn); if (isSignedIn) { authorizeButton.style.display = 'none'; signoutButton.style.display = 'inline-block'; fetchButton.style.display = 'inline-block'; fetchButton.disabled = false; } else { authorizeButton.style.display = 'inline-block'; signoutButton.style.display = 'none'; fetchButton.style.display = 'none'; fetchButton.disabled = true; maybeEnableButtons(); } }
        function maybeEnableButtons() { console.log(`Checking button status: GAPI=${gapiInited}, GIS=${gisInited}`); if (gapiInited && gisInited) { console.log("Both GAPI and GIS initialized."); if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') { authorizeButton.disabled = true; console.log("Authorize button kept disabled: Client ID placeholder found."); } else { const isSignedIn = gapi.client.getToken() !== null; authorizeButton.disabled = isSignedIn; console.log(`Authorize button enabled state set to: ${!isSignedIn}`); if(isSignedIn) { authorizeButton.style.display = 'none'; } else { authorizeButton.style.display = 'inline-block'; } } } else { console.log("Initialization incomplete. Keeping authorize button disabled."); authorizeButton.disabled = true; } }

        // --- Calendar Data Fetching and Analysis ---
        function getSelectedWeekdays() { const checkboxes = weekdaysContainer.querySelectorAll('.weekday-checkbox:checked'); const days = Array.from(checkboxes).map(cb => parseInt(cb.value, 10)); console.log("Selected weekdays:", days); return days; }
        function getSelectedTimeZone() { const selectedTz = timeZoneSelect.value; if (selectedTz === 'local') { const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone; console.log("Selected timezone: local, resolved to:", localTz); return localTz; } console.log("Selected timezone:", selectedTz); return selectedTz; }

        // fetchCalendarData - UPDATED call to displayResults
        async function fetchCalendarData() {
             console.log("fetchCalendarData called");
            // --- 1. Get User Input ---
            const startHourInput = parseInt(document.getElementById('startHour').value, 10);
            const endHourInput = parseInt(document.getElementById('endHour').value, 10);
            const daysToQueryInput = parseInt(document.getElementById('daysToQuery').value, 10); // Use this variable name
            const selectedWeekdays = getSelectedWeekdays();
            const selectedTimeZone = getSelectedTimeZone();

            // --- Input Validation --- (No changes)
            if (isNaN(startHourInput) || isNaN(endHourInput) || isNaN(daysToQueryInput) || startHourInput < 0 || startHourInput > 23 || endHourInput <= startHourInput || endHourInput > 23 || daysToQueryInput < 1 || daysToQueryInput > 90) { displayError("Invalid input. Check start/end hours (0-23, end > start) and days (1-90)."); return; } if (selectedWeekdays.length === 0) { displayError("Please select at least one workday."); return; } if (!selectedTimeZone) { displayError("Could not determine timezone. Please select one."); return; }

            // --- UI Updates --- (No changes)
            fetchButton.disabled = true; loadingSpinner.style.display = 'inline-block'; resultsDiv.style.display = 'none'; numericalResultsDiv.innerHTML = ''; dailyBreakdownDiv.innerHTML = ''; errorMessageElement.style.display = 'none'; chartCanvas.style.display = 'none'; chartMessageElement.style.display = 'none'; if (utilizationChartInstance) { utilizationChartInstance.destroy(); utilizationChartInstance = null; console.log("Previous chart destroyed."); }

            try {
                // --- 2. Calculate Date Range --- (No changes)
                const now = new Date(); const timeMaxUTC = new Date(now); timeMaxUTC.setUTCHours(23, 59, 59, 999); const timeMinUTC = new Date(now); timeMinUTC.setUTCDate(now.getUTCDate() - daysToQueryInput); timeMinUTC.setUTCHours(0, 0, 0, 0); console.log(`Fetching events from ${timeMinUTC.toISOString()} to ${timeMaxUTC.toISOString()} (UTC)`);

                // --- 3. Fetch Events --- (No changes)
                const events = await listUpcomingEvents(timeMinUTC.toISOString(), timeMaxUTC.toISOString()); if (events === null) { console.log("Event fetching failed or returned null."); return; } console.log(`Fetched ${events.length} events.`);

                // --- 4. Analyze Events --- (No changes)
                const analysis = analyzeEvents( events, timeMinUTC, daysToQueryInput, startHourInput, endHourInput, selectedWeekdays, selectedTimeZone ); console.log("Analysis complete:", analysis);

                // --- 5. Display Results --- FIXED ---
                // Pass the correct variable 'daysToQueryInput' for the 'totalDaysQueried' parameter
                displayResults(analysis, startHourInput, endHourInput, daysToQueryInput, selectedWeekdays, selectedTimeZone);

            } catch (err) { console.error('Error fetching or analyzing calendar data:', err); if (err instanceof RangeError && err.message.includes("time zone")) { displayError(`Error: The selected timezone "${selectedTimeZone}" is not recognized by your browser. Please choose another or use "Local Browser Time".`); } else { displayError(`Error: ${err.message || 'Could not fetch or analyze data.'}`); } }
            finally { fetchButton.disabled = false; loadingSpinner.style.display = 'none'; console.log("Fetch/Analyze process finished."); }
        }

        // listUpcomingEvents - (No changes)
        async function listUpcomingEvents(timeMinISO_UTC, timeMaxISO_UTC) { console.log("Calling Google Calendar API events.list"); if (!gapiInited || !gapi.client || !gapi.client.calendar) { console.error("GAPI client or Calendar API not initialized."); displayError("GAPI client or Calendar API not ready. Please wait or refresh."); return null; } try { const response = await gapi.client.calendar.events.list({ 'calendarId': 'primary', 'timeMin': timeMinISO_UTC, 'timeMax': timeMaxISO_UTC, 'showDeleted': false, 'singleEvents': true, 'maxResults': 2500, 'orderBy': 'startTime' }); console.log("Calendar API response received:", response); return response.result.items || []; } catch (err) { console.error('Google Calendar API Error:', err); let errorMsg = `Failed to fetch calendar events: ${err.result?.error?.message || err.message || 'Unknown API error.'}`; if (err.result?.error?.status === 'PERMISSION_DENIED') { errorMsg += ' Ensure you granted calendar access permission during sign-in.'; } else if (err.result?.error?.status === 'NOT_FOUND') { errorMsg = 'Primary calendar not found for this account.'; } else if (err.status === 401 || err.result?.error?.code === 401) { errorMsg = 'Authorization expired or invalid. Please Sign Out and Sign In again.'; handleSignoutClick(); } else if (err.status === 403 || err.result?.error?.code === 403) { errorMsg = `Permission denied (${err.result?.error?.message || 'Forbidden'}). Check API permissions in Google Cloud Console.`; } displayError(errorMsg); return null; } }

        // analyzeEvents - (No changes)
        function analyzeEvents(events, startDateUTC, numDays, workStartHour, workEndHour, selectedWeekdays, targetTimeZone) { console.log(`Analyzing ${events.length} events over ${numDays} days (starting from ${startDateUTC.toISOString()})`); console.log(`Work Hours: ${workStartHour}:00-${workEndHour}:00 in Timezone: ${targetTimeZone}`); console.log(`Selected Weekdays (0=Sun): ${selectedWeekdays.join(', ')}`); let totalMeetingMinutes = 0; let totalWorkMinutes = 0; let processedWorkdays = 0; const dailyMeetings = {}; const oneDayMillis = 24 * 60 * 60 * 1000; const getTimestampInTimezone = (dateObj, hour, minute, second, tz) => { const year = dateObj.toLocaleDateString('en-CA', { timeZone: tz, year: 'numeric' }); const month = dateObj.toLocaleDateString('en-CA', { timeZone: tz, month: '2-digit' }); const day = dateObj.toLocaleDateString('en-CA', { timeZone: tz, day: '2-digit' }); const dateStringInTz = `${year}-${month}-${day}T${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`; const dateInTz = new Date(dateStringInTz); if (isNaN(dateInTz.getTime())) { console.error(`Could not parse date string: ${dateStringInTz} for timezone ${tz}`); const fallbackDate = new Date(Date.UTC(dateObj.getUTCFullYear(), dateObj.getUTCMonth(), dateObj.getUTCDate(), hour, minute, second)); if(isNaN(fallbackDate.getTime())) { throw new Error(`Failed to create valid date for ${dateStringInTz}`); } console.warn("Using UTC fallback for timestamp calculation."); return fallbackDate.getTime(); } return dateInTz.getTime(); }; const formatTime = (dateObj, tz) => { return dateObj.toLocaleTimeString('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit', hour12: true }); }; for (let i = 0; i < numDays; i++) { const currentDay = new Date(startDateUTC.getTime() + i * oneDayMillis); const dayOfWeekString = currentDay.toLocaleDateString('en-US', { timeZone: targetTimeZone, weekday: 'short' }); const dayOfWeekInTargetTZ = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].indexOf(dayOfWeekString); if (!selectedWeekdays.includes(dayOfWeekInTargetTZ)) { continue; } processedWorkdays++; try { const workStartTimeMillis = getTimestampInTimezone(currentDay, workStartHour, 0, 0, targetTimeZone); const workEndTimeMillis = getTimestampInTimezone(currentDay, workEndHour, 0, 0, targetTimeZone); const dailyWorkMinutes = (workEndTimeMillis - workStartTimeMillis) / (1000 * 60); if (dailyWorkMinutes > 0) { totalWorkMinutes += dailyWorkMinutes; } const dateStringKey = currentDay.toLocaleDateString('en-CA', { timeZone: targetTimeZone }); events.forEach(event => { if (!event.start?.dateTime || !event.end?.dateTime) { return; } const eventStart = new Date(event.start.dateTime); const eventEnd = new Date(event.end.dateTime); const eventStartMillis = eventStart.getTime(); const eventEndMillis = eventEnd.getTime(); const overlapStart = Math.max(eventStartMillis, workStartTimeMillis); const overlapEnd = Math.min(eventEndMillis, workEndTimeMillis); if (overlapEnd > overlapStart) { const overlapMinutes = (overlapEnd - overlapStart) / (1000 * 60); totalMeetingMinutes += overlapMinutes; if (!dailyMeetings[dateStringKey]) { dailyMeetings[dateStringKey] = []; } dailyMeetings[dateStringKey].push({ start: formatTime(eventStart, targetTimeZone), end: formatTime(eventEnd, targetTimeZone), summary: event.summary || '(No Title)' }); } }); } catch (e) { console.error(`Error processing day ${currentDay.toISOString()} for timezone ${targetTimeZone}: ${e.message}`); throw e; } } console.log(`Finished analysis: ${processedWorkdays} workdays processed. Total work minutes: ${Math.round(totalWorkMinutes)}, Total meeting minutes: ${Math.round(totalMeetingMinutes)}`); return { totalMeetingMinutes: Math.round(totalMeetingMinutes), totalWorkMinutes: Math.round(totalWorkMinutes), processedWorkdays: processedWorkdays, dailyMeetings: dailyMeetings }; }

        // --- UI Display Functions --- (No changes)
        function displayResults(analysis, startHour, endHour, totalDaysQueried, selectedWeekdays, selectedTimeZone) { resultsDiv.style.display = 'block'; errorMessageElement.style.display = 'none'; numericalResultsDiv.innerHTML = ''; dailyBreakdownDiv.innerHTML = ''; chartCanvas.style.display = 'none'; chartMessageElement.style.display = 'none'; const { totalMeetingMinutes, totalWorkMinutes, processedWorkdays, dailyMeetings } = analysis; const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; const selectedDayNames = selectedWeekdays.map(d => dayNames[d]).join(', '); let numericalOutput = `<p class="font-semibold text-gray-800">Period Analyzed:</p>`; numericalOutput += `<p>Past ${totalDaysQueried} day(s)</p>`; numericalOutput += `<p class="mt-2 font-semibold text-gray-800">Configuration Used:</p>`; numericalOutput += `<ul class="list-disc list-inside space-y-1">`; numericalOutput += `<li>Work Hours: ${startHour}:00 - ${endHour}:00</li>`; numericalOutput += `<li>Work Weekdays: ${selectedDayNames}</li>`; numericalOutput += `<li>Timezone: ${selectedTimeZone}</li>`; numericalOutput += `</ul>`; if (processedWorkdays === 0) { numericalOutput += `<p class="mt-4 font-semibold text-red-600">No days matching the selected weekdays were found in the period.</p>`; numericalResultsDiv.innerHTML = numericalOutput; console.log("Results displayed: No matching workdays."); return; } const meetingHours = (totalMeetingMinutes / 60).toFixed(1); const totalWorkHours = totalWorkMinutes > 0 ? (totalWorkMinutes / 60).toFixed(1) : '0.0'; const workingMinutes = Math.max(0, totalWorkMinutes - totalMeetingMinutes); const workingHours = (workingMinutes / 60).toFixed(1); const meetingPercentage = totalWorkMinutes > 0 ? ((totalMeetingMinutes / totalWorkMinutes) * 100).toFixed(1) : '0.0'; const workingPercentage = totalWorkMinutes > 0 ? ((workingMinutes / totalWorkMinutes) * 100).toFixed(1) : '0.0'; numericalOutput += `<p class="mt-2 font-semibold text-gray-800">Time Allocation (${processedWorkdays} workdays):</p>`; numericalOutput += `<ul class="list-disc list-inside space-y-1">`; numericalOutput += `<li>Total Available Work Time: <span class="font-medium">${totalWorkHours} hrs</span> (${totalWorkMinutes} min)</li>`; numericalOutput += `<li>Time in Meetings: <span class="font-medium">${meetingHours} hrs</span> (${totalMeetingMinutes} min)</li>`; numericalOutput += `<li>Est. Work Time (Non-Meeting): <span class="font-medium">${workingHours} hrs</span> (${workingMinutes} min)</li>`; numericalOutput += `</ul>`; numericalOutput += `<p class="mt-2 font-semibold text-gray-800">Utilization:</p>`; numericalOutput += `<ul class="list-disc list-inside space-y-1">`; numericalOutput += `<li>Meeting Percentage: <span class="font-medium text-red-600">${meetingPercentage}%</span></li>`; numericalOutput += `<li>Est. Work Percentage: <span class="font-medium text-blue-600">${workingPercentage}%</span></li>`; numericalOutput += `</ul>`; numericalResultsDiv.innerHTML = numericalOutput; if (totalWorkMinutes > 0) { chartCanvas.style.display = 'block'; const ctx = chartCanvas.getContext('2d'); if (utilizationChartInstance) { utilizationChartInstance.destroy(); } utilizationChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Meetings', 'Work Time (Est.)'], datasets: [{ label: 'Time Allocation (minutes)', data: [totalMeetingMinutes, workingMinutes], backgroundColor: [ 'rgba(239, 68, 68, 0.7)', 'rgba(59, 130, 246, 0.7)' ], borderColor: [ 'rgba(239, 68, 68, 1)', 'rgba(59, 130, 246, 1)' ], borderWidth: 1, hoverOffset: 8, hoverBackgroundColor: [ 'rgba(220, 38, 38, 0.8)', 'rgba(37, 99, 235, 0.8)' ] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { padding: 15 } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) { label += ': '; } if (context.parsed !== null) { const valueMinutes = context.parsed; const valueHours = (valueMinutes / 60).toFixed(1); const total = context.dataset.data.reduce((a, b) => a + b, 0); const percentage = total > 0 ? ((valueMinutes / total) * 100).toFixed(1) : 0; label += `${valueHours} hrs (${valueMinutes} min) - ${percentage}%`; } return label; } } }, title: { display: true, text: 'Work Hours Allocation', padding: { top: 10, bottom: 10 }, font: { size: 14 } } } } }); console.log("Chart created and displayed."); } else { chartMessageElement.innerText = `No work time calculated for the ${processedWorkdays} workday(s) found. Cannot display chart.`; chartMessageElement.style.display = 'flex'; chartCanvas.style.display = 'none'; console.log("Chart not displayed: Zero total work minutes."); } let breakdownOutput = `<h3 class="text-md font-semibold text-gray-800 mb-2">Daily Meeting Breakdown (During Work Hours)</h3>`; const sortedDates = Object.keys(dailyMeetings).sort(); if (sortedDates.length === 0) { breakdownOutput += `<p class="text-sm text-gray-500">No meetings found within the configured work hours during this period.</p>`; } else { breakdownOutput += `<div class="space-y-3">`; sortedDates.forEach(dateStr => { const displayDate = new Date(dateStr + 'T00:00:00'); const displayDateStr = !isNaN(displayDate) ? displayDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) : dateStr; breakdownOutput += `<div>`; breakdownOutput += `<p class="font-semibold text-sm text-gray-700 mb-1">${displayDateStr}</p>`; breakdownOutput += `<ul class="list-disc list-inside space-y-1 pl-4 text-xs">`; dailyMeetings[dateStr].forEach(meeting => { const escapedSummary = meeting.summary.replace(/</g, "&lt;").replace(/>/g, "&gt;"); breakdownOutput += `<li><span class="font-mono text-gray-600">${meeting.start} - ${meeting.end}:</span> ${escapedSummary}</li>`; }); breakdownOutput += `</ul>`; breakdownOutput += `</div>`; }); breakdownOutput += `</div>`; } dailyBreakdownDiv.innerHTML = breakdownOutput; console.log("Daily breakdown displayed."); }
        function displayError(message) { console.log("Displaying error:", message); resultsDiv.style.display = 'block'; errorMessageElement.innerText = message; errorMessageElement.style.display = 'block'; numericalResultsDiv.innerHTML = ''; dailyBreakdownDiv.innerHTML = ''; chartCanvas.style.display = 'none'; chartMessageElement.style.display = 'none'; if (utilizationChartInstance) { utilizationChartInstance.destroy(); utilizationChartInstance = null; console.log("Chart destroyed due to error."); } }
        function displayMessage(text) { console.log("Displaying message:", text); messageText.innerText = text; messageBox.style.display = 'block'; setTimeout(closeMessageBox, 5000); }
        function closeMessageBox() { messageBox.style.display = 'none'; }

        // --- Load Libraries and Initialize --- (No changes)
        document.addEventListener('DOMContentLoaded', () => { console.log("DOM fully loaded and parsed."); authorizeButton.disabled = true; fetchButton.disabled = true; console.log("Initial button states set (disabled)."); if (CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') { displayMessage('Setup Required: Please replace "YOUR_GOOGLE_CLIENT_ID" in the HTML\'s JavaScript section with your actual Google Client ID.'); console.warn("Client ID placeholder detected. Authorization will remain disabled."); } try { if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) { console.warn("Google object not immediately available, waiting briefly..."); setTimeout(() => { console.log("Retrying GIS initialization after delay..."); if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) { console.error("GIS library still not available after delay."); displayError('Failed to initialize Google Sign-In components (timeout). Please refresh.'); gisInited = false; maybeEnableButtons(); return; } try { google.accounts.id.initialize({ client_id: CLIENT_ID }); console.log("google.accounts.id initialized successfully (after delay)."); initializeGisClient(); } catch (e) { console.error("Error during delayed GIS initialization:", e); displayError('Failed to initialize Google Sign-In components. Please refresh.'); gisInited = false; maybeEnableButtons(); } }, 1000); } else { google.accounts.id.initialize({ client_id: CLIENT_ID }); console.log("google.accounts.id initialized successfully."); initializeGisClient(); } } catch (e) { console.error("Error during initial GIS check/initialization:", e); displayError('Failed to initialize Google Sign-In components. Please refresh.'); gisInited = false; maybeEnableButtons(); } window.gapiLoaded = gapiLoadedCallback; const gapiScript = document.createElement('script'); gapiScript.src = 'https://apis.google.com/js/api.js?onload=gapiLoaded'; gapiScript.async = true; gapiScript.defer = true; document.body.appendChild(gapiScript); console.log("GAPI script added to body with onload callback."); });

    </script>
</body>
</html>
